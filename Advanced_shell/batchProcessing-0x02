#!/bin/bash

# Task 4 — Error Handling and Retry Logic

POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
OUTPUT_DIR="pokemon_data"

mkdir -p "$OUTPUT_DIR"

for pokemon in "${POKEMON_LIST[@]}"; do
    echo "Fetching data for $pokemon..."

    API_URL="https://pokeapi.co/api/v2/pokemon/$pokemon"
    OUTPUT_FILE="$OUTPUT_DIR/${pokemon}.json"

    attempts=0
    success=false

    # Retry loop (max 3 attempts)
    while [ $attempts -lt 3 ]; do
        response=$(curl -s -w "%{http_code}" "$API_URL" -o "$OUTPUT_FILE")
        http_code="$response"

        if [ "$http_code" -eq 200 ]; then
            echo "Saved data to $OUTPUT_FILE ✅"
            success=true
            break
        else
            attempts=$((attempts + 1))
            echo "Attempt $attempts failed for $pokemon (HTTP $http_code). Retrying..."
            sleep 1
        fi
    done

    # If all attempts failed → log error
    if [ "$success" = false ]; then
        echo "Failed to fetch $pokemon after 3 attempts." >> errors.txt
        echo "Skipping $pokemon ❌"
    fi

    # Delay between Pokémon requests to respect API rate limits
    sleep 1
done
